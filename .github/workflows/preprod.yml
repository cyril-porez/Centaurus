name: Preprod CI/CD

on:
  pull_request:
    branches: [ preprod ]   # CI � l'ouverture/mise � jour d'une PR vers preprod
  push:
    branches: [ preprod ]   # D�ploiement automatique apr�s merge sur preprod

concurrency:
  group: preprod
  cancel-in-progress: true

jobs:
  ci:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: V�rif rapide des fichiers compose
        run: |
          docker --version
          docker compose version
          test -f docker-compose.yml
          test -f docker-compose.preprod.yml

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/preprod'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: D�marrer l�agent SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.RPI_SSH_PRIVATE_KEY }}

      - name: Ajouter le Pi en known_hosts
        run: |
          ssh-keyscan -p "${{ secrets.RPI_PORT }}" "${{ secrets.RPI_HOST }}" >> ~/.ssh/known_hosts

      - name: D�ployer sur le Raspberry Pi
        env:
          RPI_HOST: ${{ secrets.RPI_HOST }}
          RPI_PORT: ${{ secrets.RPI_PORT }}
          RPI_USER: ${{ secrets.RPI_USER }}
          RPI_PATH: ${{ secrets.RPI_PATH }}
          DOMAIN: ${{ secrets.DOMAIN }} # optionnel si tu l�as cr��
        run: |
          set -euo pipefail
          ssh -p "$RPI_PORT" -o StrictHostKeyChecking=no "$RPI_USER@$RPI_HOST" \
            "RPI_PATH='$RPI_PATH' DOMAIN='${DOMAIN:-}' bash -s" <<'SSH'
          set -euo pipefail
          : "${RPI_PATH:?RPI_PATH non d�fini}"

          cd "$RPI_PATH"

          # Mettre � jour le d�p�t
          if [ ! -d .git ]; then
            echo "::error::Le dossier $RPI_PATH n'est pas un d�p�t git"
            exit 1
          fi
          git fetch --all --prune
          git checkout preprod || git checkout -B preprod origin/preprod
          git pull --rebase

          # D�ploiement
          if [ -n "${DOMAIN:-}" ]; then
            DOMAIN="$DOMAIN" make SUDO= preprod
          else
            make SUDO= preprod
          fi
SSH
